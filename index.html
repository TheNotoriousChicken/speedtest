<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINEWAVE // TELEMETRY</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-color: #0c0c0c;
            --accent-cyan: #00f3ff;
            --accent-purple: #bc13fe;
            --accent-red: #ff0055;
            --text-muted: #555;
            --font-mono: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: #eee;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 70px 100px 1fr 60px; /* Header, Stats, Gauge, Footer */
            gap: 15px;
            width: 95vw;
            height: 95vh;
            max-width: 1100px;
        }

        /* --- 1. HEADER (CONTROLS) --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-color);
            border: 1px solid #222;
            padding: 0 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .brand {
            font-family: var(--font-mono);
            font-weight: 900;
            font-size: 1.4rem;
            letter-spacing: -1px;
            color: #fff;
        }

        .control-group { display: flex; gap: 10px; }

        select, button {
            background: #000;
            color: white;
            border: 1px solid #333;
            padding: 8px 12px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        select:hover { border-color: #666; }

        .btn-start {
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            font-weight: bold;
            text-transform: uppercase;
            padding-left: 25px;
            padding-right: 25px;
        }
        .btn-start:hover { background: var(--accent-cyan); color: #000; box-shadow: 0 0 20px rgba(0,243,255,0.4); }
        
        .btn-stop {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }
        .btn-stop:hover { background: var(--accent-red); color: #fff; }

        /* --- 2. TOP HUD STATS (Requested Feature) --- */
        .hud-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: linear-gradient(180deg, #111 0%, var(--panel-color) 100%);
            border: 1px solid #222;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        /* Decorative top accent */
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0; left: 10%; right: 10%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #444, transparent);
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .stat-val {
            font-family: var(--font-mono);
            font-size: 1.6rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .stat-unit {
            font-size: 0.75rem;
            color: #666;
        }

        /* --- 3. GAUGE AREA --- */
        .gauge-wrapper {
            position: relative;
            background: radial-gradient(circle at center, #151515 0%, #050505 70%);
            border: 1px solid #222;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas { z-index: 2; }

        /* --- 4. FOOTER (TIMERS) --- */
        .footer-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-top: 1px solid #222;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: #666;
        }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="controls">
            <div class="brand">SINEWAVE <span style="color:var(--accent-cyan)">//</span> OPS</div>
            <div class="control-group">
                <select id="serverSelect">
                    <option value="https://speed.cloudflare.com/__down?bytes=100000000">Cloudflare (Global)</option>
                    <option value="https://speed.hetzner.de/100MB.bin">Hetzner (EU)</option>
                    <option value="https://proof.ovh.net/files/100Mb.dat">OVH (Global)</option>
                </select>
                <select id="durationSelect">
                    <option value="5">5 Minutes</option>
                    <option value="10">10 Minutes</option>
                    <option value="999">Infinite</option>
                </select>
                <button id="actionBtn" class="btn-start" onclick="toggleTest()">Start Test</button>
            </div>
        </div>

        <div class="hud-stats">
            <div class="stat-card">
                <div class="stat-label">Latency</div>
                <div class="stat-val" id="pingVal">--</div>
                <div class="stat-unit">ms</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Peak Speed</div>
                <div class="stat-val" id="peakVal">0.0</div>
                <div class="stat-unit">Mbps</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Speed</div>
                <div class="stat-val" id="avgVal">0.0</div>
                <div class="stat-unit">Mbps</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Data Used</div>
                <div class="stat-val" id="dataVal">0.00</div>
                <div class="stat-unit">GB</div>
            </div>
        </div>

        <div class="gauge-wrapper" id="gaugeContainer">
            <canvas id="gaugeCanvas"></canvas>
        </div>

        <div class="footer-bar">
            <div id="statusText">SYSTEM READY</div>
            <div>
                ELAPSED: <span id="timeElapsed" style="color:#fff">00:00</span> &nbsp;|&nbsp; 
                REMAINING: <span id="timeRem" style="color:#fff">--:--</span>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC VARS ---
        let isRunning = false;
        let workers = [];
        const CONCURRENT_STREAMS = 6;
        
        let totalBytesLoaded = 0;
        let lastByteCount = 0;
        let lastCheckTime = 0;
        let testStartTime = 0;
        let testEndTime = 0;
        let uiInterval;

        // Metrics
        let currentVisualSpeed = 0; 
        let targetSpeed = 0;        
        let peakSpeed = 0;
        let rotationOffset = 0; 

        // --- CANVAS SETUP ---
        const canvas = document.getElementById('gaugeCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY, radius;

        function resizeCanvas() {
            const wrapper = document.getElementById('gaugeContainer');
            width = wrapper.clientWidth;
            height = wrapper.clientHeight;
            canvas.width = width;
            canvas.height = height;
            centerX = width / 2;
            centerY = height / 2;
            radius = (Math.min(width, height) / 2) - 40; 
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- ANIMATION LOOP ---
        function animate() {
            ctx.clearRect(0, 0, width, height);
            
            // Easing
            const diff = targetSpeed - currentVisualSpeed;
            if (Math.abs(diff) > 0.1) currentVisualSpeed += diff * 0.1;
            else currentVisualSpeed = targetSpeed;

            drawGauge(currentVisualSpeed);
            rotationOffset += 0.003; 
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);

        // --- DRAWING THE GAUGE ---
        function drawGauge(speedMbps) {
            const maxVal = 1000;
            const logSpeed = Math.log10(speedMbps + 1); 
            const logMax = Math.log10(maxVal + 1);
            let progress = logSpeed / logMax;
            if (progress > 1) progress = 1; if (progress < 0) progress = 0;

            const startAngle = Math.PI * 0.85; 
            const endAngle = Math.PI * 2.15;   
            const totalAngle = endAngle - startAngle;
            const currentAngle = startAngle + (totalAngle * progress);

            // Idle Ring
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(rotationOffset);
            ctx.beginPath();
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 2;
            ctx.setLineDash([2, 10]);
            ctx.arc(0, 0, radius + 15, 0, Math.PI * 2);
            ctx.stroke();
            ctx.restore();

            // Background Track
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.strokeStyle = '#111';
            ctx.lineWidth = 30;
            ctx.lineCap = 'butt';
            ctx.stroke();

            // Active Bar
            if (speedMbps > 0.5) {
                const grad = ctx.createLinearGradient(0, height, width, 0);
                grad.addColorStop(0, '#00f3ff'); 
                grad.addColorStop(0.5, '#bc13fe');
                grad.addColorStop(1, '#ff0055');

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
                ctx.strokeStyle = grad;
                ctx.lineWidth = 30;
                ctx.lineCap = 'butt';
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(0, 243, 255, 0.2)';
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            // Central Text
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 80px "Courier New"';
            ctx.fillText(speedMbps.toFixed(0), centerX, centerY);
            
            ctx.fillStyle = '#444';
            ctx.font = '12px sans-serif';
            ctx.fillText('REAL-TIME MBPS', centerX, centerY + 50);

            // Ticks
            const getTickAngle = (val) => startAngle + (totalAngle * (Math.log10(val + 1) / logMax));
            [0, 10, 50, 100, 500, 1000].forEach(val => {
                drawTick(val, getTickAngle(val));
            });
        }

        function drawTick(label, angle) {
            const innerR = radius - 45;
            const x = centerX + Math.cos(angle) * innerR;
            const y = centerY + Math.sin(angle) * innerR;
            ctx.fillStyle = '#666';
            ctx.font = '11px sans-serif';
            ctx.fillText(label, x, y);
        }

        // --- TEST LOGIC ---
        function toggleTest() {
            if (isRunning) stopTest();
            else initTest();
        }

        async function initTest() {
            // 1. Reset UI
            document.getElementById('actionBtn').disabled = true;
            document.getElementById('statusText').innerText = "CALCULATING LATENCY...";
            document.getElementById('pingVal').innerText = "--";
            document.getElementById('peakVal').innerText = "0.0";
            document.getElementById('avgVal').innerText = "0.0";
            
            // 2. Run Ping Test
            const url = document.getElementById('serverSelect').value;
            try {
                const pingStart = performance.now();
                await fetch(url + "&t=" + Math.random(), { method: 'HEAD', cache: 'no-store', mode: 'cors' });
                const pingEnd = performance.now();
                const pingMs = (pingEnd - pingStart).toFixed(0);
                document.getElementById('pingVal').innerText = pingMs;
                document.getElementById('pingVal').style.color = "#00ff9d";
            } catch (e) {
                document.getElementById('pingVal').innerText = "Err";
            }

            // 3. Start Download
            document.getElementById('actionBtn').disabled = false;
            startDownloadLoop();
        }

        function startDownloadLoop() {
            isRunning = true;
            totalBytesLoaded = 0;
            lastByteCount = 0;
            peakSpeed = 0;
            targetSpeed = 0;

            const btn = document.getElementById('actionBtn');
            btn.innerText = "ABORT";
            btn.className = "btn-stop";
            document.getElementById('statusText').innerText = "STRESS TEST IN PROGRESS...";

            const durationMins = parseFloat(document.getElementById('durationSelect').value);
            testStartTime = Date.now();
            lastCheckTime = testStartTime;
            testEndTime = testStartTime + (durationMins * 60 * 1000);

            const url = document.getElementById('serverSelect').value;
            workers = [];
            for(let i=0; i<CONCURRENT_STREAMS; i++) spawnWorker(url);

            uiInterval = setInterval(updateMetrics, 250); // 4x per second
        }

        function stopTest() {
            isRunning = false;
            clearInterval(uiInterval);
            workers.forEach(w => w.abort());
            
            const btn = document.getElementById('actionBtn');
            btn.innerText = "START TEST";
            btn.className = "btn-start";
            document.getElementById('statusText').innerText = "TEST COMPLETE";
            targetSpeed = 0;
        }

        async function spawnWorker(url) {
            if(!isRunning) return;
            const controller = new AbortController();
            workers.push(controller);
            try {
                const response = await fetch(url + "&t=" + Math.random(), {
                    signal: controller.signal, cache: "no-store", mode: "cors"
                });
                const reader = response.body.getReader();
                while(true) {
                    const {done, value} = await reader.read();
                    if(done || !isRunning) break;
                    if(value) totalBytesLoaded += value.length;
                }
                if(isRunning) spawnWorker(url);
            } catch(e) { if(isRunning) setTimeout(() => spawnWorker(url), 1000); }
        }

        function updateMetrics() {
            const now = Date.now();
            if(now > testEndTime) { stopTest(); return; }

            // 1. Instant Speed (Windowed)
            const timeDiff = (now - lastCheckTime) / 1000;
            if(timeDiff <= 0) return;
            const bytesDiff = totalBytesLoaded - lastByteCount;
            const instantMbps = (bytesDiff * 8 / timeDiff) / (1024 * 1024);

            // 2. Average Speed (Global)
            const totalElapsed = (now - testStartTime) / 1000;
            const avgMbps = (totalBytesLoaded * 8 / totalElapsed) / (1024 * 1024);

            // Update Logic Stats
            if(instantMbps > peakSpeed) peakSpeed = instantMbps;
            targetSpeed = instantMbps; // Feeds the gauge animation
            lastByteCount = totalBytesLoaded;
            lastCheckTime = now;

            // DOM Updates
            document.getElementById('peakVal').innerText = peakSpeed.toFixed(0);
            document.getElementById('avgVal').innerText = avgMbps.toFixed(0);
            document.getElementById('dataVal').innerText = (totalBytesLoaded / (1024**3)).toFixed(2);
            
            // Timers
            const remain = Math.max(0, (testEndTime - now)/1000);
            document.getElementById('timeElapsed').innerText = fmtTime(totalElapsed);
            document.getElementById('timeRem').innerText = fmtTime(remain);
        }

        function fmtTime(s) {
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec.toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>
