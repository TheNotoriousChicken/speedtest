<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINEWAVE // GIGABIT OPS</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-color: #0a0a0a;
            --accent-cyan: #00f3ff;
            --accent-purple: #bc13fe;
            --accent-red: #ff0055;
            --text-muted: #444;
            --font-mono: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: #eee;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 80px 1fr 100px;
            gap: 15px;
            width: 95vw;
            height: 90vh;
            max-width: 1000px;
            position: relative;
        }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-color);
            border: 1px solid #222;
            padding: 0 30px;
            border-radius: 8px;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .brand {
            font-family: var(--font-mono);
            font-weight: 900;
            font-size: 1.5rem;
            letter-spacing: -1px;
            color: #fff;
        }

        .control-group { display: flex; gap: 10px; }

        select, button {
            background: #000;
            color: white;
            border: 1px solid #333;
            padding: 10px 15px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            transition: 0.2s;
        }

        select:hover { border-color: #666; }

        .btn-start {
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
            font-weight: bold;
            text-transform: uppercase;
        }
        .btn-start:hover { background: var(--accent-cyan); color: #000; box-shadow: 0 0 25px var(--accent-cyan); }
        
        .btn-stop {
            border-color: var(--accent-red);
            color: var(--accent-red);
            font-weight: bold;
        }
        .btn-stop:hover { background: var(--accent-red); color: white; box-shadow: 0 0 25px var(--accent-red); }

        /* --- GAUGE AREA --- */
        .gauge-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #111 0%, #050505 70%);
            border: 1px solid #222;
            border-radius: 8px;
            overflow: hidden;
        }

        canvas { z-index: 2; }

        /* --- STATS FOOTER --- */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: var(--panel-color);
            border: 1px solid #222;
            border-radius: 8px;
            padding: 15px;
        }

        .stat-item {
            text-align: center;
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-item:last-child { border-right: none; }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .stat-val {
            font-family: var(--font-mono);
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
        }

        .stat-unit { font-size: 0.8rem; color: #666; margin-top: -5px;}
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="controls">
            <div class="brand">SINEWAVE <span style="color:var(--accent-cyan)">//</span> GIGABIT</div>
            <div class="control-group">
                <select id="serverSelect">
                    <option value="https://speed.cloudflare.com/__down?bytes=100000000">Cloudflare (Global)</option>
                    <option value="https://speed.hetzner.de/100MB.bin">Hetzner (EU)</option>
                    <option value="https://proof.ovh.net/files/100Mb.dat">OVH (Global)</option>
                </select>
                <select id="durationSelect">
                    <option value="5">5 Minutes</option>
                    <option value="10">10 Minutes</option>
                    <option value="999">Infinite</option>
                </select>
                <button id="actionBtn" class="btn-start" onclick="toggleTest()">Start Test</button>
            </div>
        </div>

        <div class="gauge-container" id="gaugeWrapper">
            <canvas id="gaugeCanvas"></canvas>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">Data Consumed</div>
                <div class="stat-val" id="dataVal">0.00</div>
                <span class="stat-unit">GB</span>
            </div>
            <div class="stat-item">
                <div class="stat-label">Peak Speed</div>
                <div class="stat-val" id="peakVal">0.0</div>
                <span class="stat-unit">Mbps</span>
            </div>
            <div class="stat-item">
                <div class="stat-label">Run Time</div>
                <div class="stat-val" id="timeElapsed">00:00</div>
                <span class="stat-unit">MM:SS</span>
            </div>
            <div class="stat-item">
                <div class="stat-label">Remaining</div>
                <div class="stat-val" id="timeRem">--:--</div>
                <span class="stat-unit">MM:SS</span>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC ENGINE ---
        let isRunning = false;
        let workers = [];
        const CONCURRENT_STREAMS = 6;
        
        let totalBytesLoaded = 0;
        let lastByteCount = 0;
        let lastCheckTime = 0;
        let testStartTime = 0;
        let testEndTime = 0;
        let uiInterval;

        let currentVisualSpeed = 0; 
        let targetSpeed = 0;        
        let peakSpeed = 0;
        let rotationOffset = 0;     

        // --- CANVAS ENGINE ---
        const canvas = document.getElementById('gaugeCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY, radius;

        function resizeCanvas() {
            const wrapper = document.getElementById('gaugeWrapper');
            width = wrapper.clientWidth;
            height = wrapper.clientHeight;
            canvas.width = width;
            canvas.height = height;
            centerX = width / 2;
            centerY = height / 2;
            // Responsive Radius
            radius = (Math.min(width, height) / 2) - 50; 
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function animate() {
            ctx.clearRect(0, 0, width, height);

            // Smooth Interpolation (Easing)
            const diff = targetSpeed - currentVisualSpeed;
            if (Math.abs(diff) > 0.1) {
                currentVisualSpeed += diff * 0.08; // Slightly faster reaction
            } else {
                currentVisualSpeed = targetSpeed;
            }

            drawGauge(currentVisualSpeed);
            rotationOffset += 0.002; // Slow background spin
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);

        function drawGauge(speedMbps) {
            // Logarithmic Scale: Cap at 1000 Mbps
            // We use Log10 so that 10, 100, 1000 are evenly spaced steps
            const maxVal = 1000;
            // +1 to handle 0 speed cleanly (log(1)=0)
            const logSpeed = Math.log10(speedMbps + 1); 
            const logMax = Math.log10(maxVal + 1);
            
            let progress = logSpeed / logMax;
            if (progress > 1) progress = 1;
            if (progress < 0) progress = 0;

            const startAngle = Math.PI * 0.8; 
            const endAngle = Math.PI * 2.2;   
            const totalAngle = endAngle - startAngle;
            const currentAngle = startAngle + (totalAngle * progress);

            // 1. Idle Ring (Decoration)
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(rotationOffset);
            ctx.beginPath();
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 15]);
            ctx.arc(0, 0, radius + 30, 0, Math.PI * 2);
            ctx.stroke();
            ctx.restore();

            // 2. Track Background
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.strokeStyle = '#151515';
            ctx.lineWidth = 25;
            ctx.lineCap = 'round';
            ctx.stroke();

            // 3. Active Bar (Gradient)
            if (speedMbps > 0.5) {
                const grad = ctx.createLinearGradient(0, height, width, 0);
                grad.addColorStop(0, '#00f3ff');  // Cyan (Low)
                grad.addColorStop(0.6, '#bc13fe'); // Purple (Mid)
                grad.addColorStop(1, '#ff0055');   // Red (High/Gigabit)

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
                ctx.strokeStyle = grad;
                ctx.lineWidth = 25;
                ctx.lineCap = 'round';
                // Glow effect
                ctx.shadowBlur = 20;
                ctx.shadowColor = 'rgba(0, 243, 255, 0.3)';
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            // 4. Center Data
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 90px "Courier New"';
            ctx.fillText(speedMbps.toFixed(0), centerX, centerY);

            ctx.fillStyle = '#00f3ff';
            ctx.font = '14px sans-serif';
            ctx.letterSpacing = '3px';
            ctx.fillText('DOWNLOAD MBPS', centerX, centerY + 60);

            // 5. Ticks (Logarithmic placement)
            // Helper to find angle for specific value
            const getTickAngle = (val) => {
                const p = Math.log10(val + 1) / Math.log10(1001);
                return startAngle + (totalAngle * p);
            }

            drawTick(0, '0', startAngle);
            drawTick(10, '10', getTickAngle(10));
            drawTick(50, '50', getTickAngle(50));
            drawTick(100, '100', getTickAngle(100));
            drawTick(500, '500', getTickAngle(500));
            drawTick(1000, '1G', endAngle);
        }

        function drawTick(val, label, angle) {
            const innerR = radius - 40;
            const x = centerX + Math.cos(angle) * innerR;
            const y = centerY + Math.sin(angle) * innerR;
            
            ctx.fillStyle = '#555';
            ctx.font = 'bold 12px sans-serif';
            ctx.fillText(label, x, y);
        }

        // --- TEST CONTROLLER ---
        function toggleTest() {
            if (isRunning) stopTest();
            else startTest();
        }

        function startTest() {
            isRunning = true;
            totalBytesLoaded = 0;
            lastByteCount = 0;
            peakSpeed = 0;
            targetSpeed = 0;
            currentVisualSpeed = 0;

            const btn = document.getElementById('actionBtn');
            btn.innerText = "ABORT";
            btn.className = "btn-stop";

            const durationMins = parseFloat(document.getElementById('durationSelect').value);
            testStartTime = Date.now();
            lastCheckTime = testStartTime;
            testEndTime = testStartTime + (durationMins * 60 * 1000);

            const targetUrl = document.getElementById('serverSelect').value;
            workers = [];
            for(let i=0; i<CONCURRENT_STREAMS; i++) spawnWorker(targetUrl);

            // Update UI loop
            uiInterval = setInterval(updateData, 200); // 5Hz update rate
        }

        function stopTest() {
            isRunning = false;
            clearInterval(uiInterval);
            workers.forEach(w => w.abort());
            
            document.getElementById('actionBtn').innerText = "START TEST";
            document.getElementById('actionBtn').className = "btn-start";
            targetSpeed = 0;
        }

        async function spawnWorker(url) {
            if(!isRunning) return;
            const controller = new AbortController();
            workers.push(controller);
            try {
                const response = await fetch(url + (url.includes('?') ? '&' : '?') + 't=' + Math.random(), {
                    signal: controller.signal, cache: "no-store", mode: "cors"
                });
                const reader = response.body.getReader();
                while(true) {
                    const {done, value} = await reader.read();
                    if(done || !isRunning) break;
                    if(value) totalBytesLoaded += value.length;
                }
                if(isRunning) spawnWorker(url);
            } catch(e) { if(isRunning) setTimeout(() => spawnWorker(url), 1000); }
        }

        function updateData() {
            const now = Date.now();
            if(now > testEndTime) { stopTest(); return; }

            const timeDiff = (now - lastCheckTime) / 1000; 
            if(timeDiff <= 0) return;

            const bytesDiff = totalBytesLoaded - lastByteCount;
            const bits = bytesDiff * 8;
            const mbps = (bits / timeDiff) / (1024 * 1024);

            // Smoothing filter (prevents jitter)
            // If new speed is drastically different, blend it; otherwise take it
            targetSpeed = mbps; 
            if(mbps > peakSpeed) peakSpeed = mbps;

            lastByteCount = totalBytesLoaded;
            lastCheckTime = now;

            // DOM Updates
            const gb = totalBytesLoaded / (1024 * 1024 * 1024);
            document.getElementById('dataVal').innerText = gb.toFixed(2);
            document.getElementById('peakVal').innerText = peakSpeed.toFixed(0);
            
            const elapsed = Math.floor((now - testStartTime)/1000);
            const remain = Math.floor((testEndTime - now)/1000);
            document.getElementById('timeElapsed').innerText = fmtTime(elapsed);
            document.getElementById('timeRem').innerText = fmtTime(remain);
        }

        function fmtTime(s) {
            if (s < 0) s = 0;
            const m = Math.floor(s/60);
            const sec = s%60;
            return `${m}:${sec.toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>
