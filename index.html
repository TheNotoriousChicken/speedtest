<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Speed Test</title>

<style>
:root{
  --bg:#0e1117;
  --panel:#161b22;
  --border:#262c36;
  --text:#e6edf3;
  --muted:#8b949e;
  --accent:#00c2ff;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.dashboard{
  width:92vw;
  max-width:1100px;
  height:88vh;
  display:grid;
  grid-template-rows:auto auto 1fr auto;
  gap:14px;
}

/* Header */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 22px;
  background:var(--panel);
  border-radius:14px;
  border:1px solid var(--border);
}

.logo{
  font-size:1.2rem;
  font-weight:600;
}

.controls{
  display:flex;
  gap:10px;
}

button{
  background:#0d1117;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px 16px;
  cursor:pointer;
}

button.start{
  background:var(--accent);
  color:#000;
  font-weight:600;
}

button.stop{
  background:#2a1a1a;
  color:#ff6b6b;
}

/* Stats */
.stats{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  text-align:center;
}

.card label{
  font-size:.7rem;
  color:var(--muted);
}

.card .value{
  font-size:1.6rem;
  font-weight:600;
}

/* Gauge */
.gauge{
  background:var(--panel);
  border-radius:18px;
  border:1px solid var(--border);
  display:flex;
  justify-content:center;
  align-items:center;
}

canvas{width:100%;height:100%}

/* Footer */
.footer{
  display:flex;
  justify-content:space-between;
  padding:10px 16px;
  background:var(--panel);
  border-radius:12px;
  border:1px solid var(--border);
  font-size:.8rem;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="dashboard">

  <div class="header">
    <div class="logo">Speed Test</div>
    <div class="controls">
      <button id="startBtn" class="start">Start</button>
      <button id="stopBtn" class="stop" disabled>Stop</button>
    </div>
  </div>

  <div class="stats">
    <div class="card"><label>Ping</label><div class="value" id="ping">--</div></div>
    <div class="card"><label>Peak</label><div class="value" id="peak">0</div></div>
    <div class="card"><label>Average</label><div class="value" id="avg">0</div></div>
    <div class="card"><label>Data</label><div class="value" id="data">0.00</div></div>
  </div>

  <div class="gauge">
    <canvas id="gauge"></canvas>
  </div>

  <div class="footer">
    <div id="status">Ready</div>
    <div id="time">00:00</div>
  </div>

</div>

<script>
/* CONFIG */
const TEST_URL = 'https://speed.cloudflare.com/__down?bytes=100000000';
const STREAMS = 6;

/* STATE */
let running=false;
let controllers=[];
let totalBytes=0,lastBytes=0;
let startTime=0,lastTime=0;
let peak=0,targetSpeed=0,displaySpeed=0;

/* UI */
const startBtn=document.getElementById('startBtn');
const stopBtn=document.getElementById('stopBtn');
const pingEl=document.getElementById('ping');
const peakEl=document.getElementById('peak');
const avgEl=document.getElementById('avg');
const dataEl=document.getElementById('data');
const timeEl=document.getElementById('time');
const statusEl=document.getElementById('status');

/* CANVAS */
const canvas=document.getElementById('gauge');
const ctx=canvas.getContext('2d');
function resize(){
  canvas.width=canvas.clientWidth;
  canvas.height=canvas.clientHeight;
}
window.addEventListener('resize',resize); resize();

function drawGauge(speed){
  const w=canvas.width,h=canvas.height;
  const cx=w/2,cy=h/2,r=Math.min(w,h)/2-40;
  const max=200;

  displaySpeed += (speed-displaySpeed)*0.15;

  ctx.clearRect(0,0,w,h);
  ctx.lineWidth=18;
  ctx.strokeStyle='#1f2937';
  ctx.beginPath();
  ctx.arc(cx,cy,r,Math.PI,0);
  ctx.stroke();

  const p=Math.min(displaySpeed/max,1);
  const grad=ctx.createLinearGradient(0,0,w,0);
  grad.addColorStop(0,'#00c2ff');
  grad.addColorStop(1,'#0077ff');

  ctx.strokeStyle=grad;
  ctx.beginPath();
  ctx.arc(cx,cy,r,Math.PI,Math.PI+p*Math.PI);
  ctx.stroke();

  ctx.fillStyle='#fff';
  ctx.font='700 64px system-ui';
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText(displaySpeed.toFixed(0),cx,cy);
  ctx.font='14px system-ui';
  ctx.fillText('Mbps',cx,cy+40);

  requestAnimationFrame(()=>drawGauge(targetSpeed));
}
drawGauge(0);

/* WORKERS */
async function spawn(isMain){
  if(!running) return;
  const ctrl=new AbortController();
  controllers.push(ctrl);
  const t0=performance.now();

  try{
    const res=await fetch(TEST_URL+'&t='+Math.random(),{signal:ctrl.signal,cache:'no-store'});
    if(isMain){
      pingEl.textContent=(performance.now()-t0).toFixed(0);
    }
    const reader=res.body.getReader();
    while(true){
      const {done,value}=await reader.read();
      if(done||!running) break;
      totalBytes+=value.length;
    }
    spawn(false);
  }catch{}
}

/* LOOP */
function loop(){
  if(!running) return;
  const now=Date.now();
  const dt=(now-lastTime)/1000;
  if(dt>=0.4){
    const diff=totalBytes-lastBytes;
    const speed=(diff*8)/(dt*1024*1024);
    targetSpeed=speed;
    peak=Math.max(peak,speed);

    peakEl.textContent=peak.toFixed(0);
    avgEl.textContent=((totalBytes*8)/((now-startTime)/1000)/1024/1024).toFixed(0);
    dataEl.textContent=(totalBytes/1024/1024/1024).toFixed(2);

    lastBytes=totalBytes;
    lastTime=now;
  }
  timeEl.textContent=new Date(now-startTime).toISOString().substr(14,5);
  requestAnimationFrame(loop);
}

/* CONTROLS */
startBtn.onclick=()=>{
  running=true;
  totalBytes=lastBytes=0;
  peak=targetSpeed=0;
  startTime=lastTime=Date.now();
  statusEl.textContent='Testingâ€¦';
  startBtn.disabled=true;
  stopBtn.disabled=false;
  controllers=[];
  spawn(true);
  for(let i=1;i<STREAMS;i++) setTimeout(()=>spawn(false),100*i);
  loop();
};

stopBtn.onclick=()=>{
  running=false;
  controllers.forEach(c=>c.abort());
  statusEl.textContent='Finished';
  startBtn.disabled=false;
  stopBtn.disabled=true;
};
</script>
</body>
</html>
